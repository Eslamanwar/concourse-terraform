#!/usr/bin/env python3

# stdlib
import os
import sys
from distutils.util import strtobool

# local
import lib.commands


# =============================================================================
# constants
# =============================================================================
DEBUG = 'DEBUG'
ERROR_ON_NO_CHANGES = 'ERROR_ON_NO_CHANGES'
TERRAFORM_SOURCE_DIR = 'TF_WORKING_DIR'
TERRAFORM_DIR_PATH = 'TF_DIR_PATH'


# =============================================================================
# process_args
# =============================================================================
def process_args(args: list) -> None:
    command = args[0]
    if command == lib.commands.PLAN:
        terraform_source_dir = os.environ[TERRAFORM_SOURCE_DIR]
        terraform_dir_path = os.environ.get(TERRAFORM_DIR_PATH)
        error_on_no_changes = os.environ.get(ERROR_ON_NO_CHANGES)
        if error_on_no_changes:
            # convert to bool if specified
            error_on_no_changes = bool(strtobool(error_on_no_changes))
        debug = os.environ.get(DEBUG)
        if debug:
            # convert to bool if specified
            debug = bool(strtobool(debug))
        lib.commands.plan(
            terraform_source_dir,
            terraform_dir_path=terraform_dir_path,
            error_on_no_changes=error_on_no_changes,
            debug=debug)
    elif args[0] == lib.commands.APPLY:
        terraform_source_dir = os.environ[TERRAFORM_SOURCE_DIR]
        terraform_dir_path = os.environ.get(TERRAFORM_DIR_PATH)
        debug = os.environ.get(DEBUG)
        if debug:
            # convert to bool if specified
            debug = bool(strtobool(debug))
        lib.commands.apply(
            terraform_source_dir,
            terraform_dir_path=terraform_dir_path,
            debug=debug)
    else:
        print(f'command not recognized: {command}')
        print(f"available commands: {' '.join(lib.command.COMMANDS)}")
        raise NotImplementedError


# =============================================================================
# main
# =============================================================================
def main(args: list) -> None:
    process_args(args)


if __name__ == "__main__":
    main(sys.argv[1:])
