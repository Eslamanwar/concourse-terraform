#!/usr/bin/env sh

set -ex

readonly CONSUL_DOMAIN="consul"
readonly CONSUL_IP="127.0.0.1"
readonly CONSUL_DNS_PORT=8600

readonly DNS_MASQ_CONFIG_DIR="/etc/dnsmasq.d"
readonly CONSUL_DNS_MASQ_CONFIG_FILE="${DNS_MASQ_CONFIG_DIR}/10-consul.conf"

mkdir -p "${DNS_MASQ_CONFIG_DIR}"

cat >"${CONSUL_DNS_MASQ_CONFIG_FILE}" <<EOF
# Enable forward lookup of the '${CONSUL_DOMAIN}' domain:
server=/${CONSUL_DOMAIN}/${CONSUL_IP}#${CONSUL_DNS_PORT}
listen-address=${CONSUL_IP}
bind-interfaces
EOF
